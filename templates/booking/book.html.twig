{% extends 'base.html.twig' %}

{% block title %}Réservation {{ad.title}}-
	{{ parent() }}
{% endblock %}


{% block stylesheets %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" integrity="sha512-mSYUmp1HYZDFaVKK//63EcZq4iFWFjxSL+Z3T/aCt4IO9Cejm03q3NKKYN6pFQzY0SBOr8h+eCIAZHPXcpZaNw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    .datepicker table tr td.disabled, .datepicker table tr td.disabled:hover {
        color: red !important;
        cursor: not-allowed;
    }
</style>
{% endblock %}


{% block body %}
   <div class="container-fluid alert alert-info py-5">
        <div class="alert alert-info text-center">
        <h1>Demande de réservation {{ad.title}}</h1>
            Vous êtes sur le point de réserver <strong>{{ad.title}}</strong>
            <strong>{{ad.author.firstName}} {{ad.author.lastName}}</strong>
            <div class="row my-3">
                <h6>
                Dites nous quand pour quelle période vous souhaitez réserver cette annonce.
            </h6> 
            </div>
        <hr>
        {% set daydate = "now"|date("d/m/Y") %}
            {{form_start(form)}}
            
                
            <div class="row">
                <div class="col">
                <h3>Votre date d'arrivée</h3>

                {{ form_row(form.startDate, {'attr': {'class': 'datepicker'}}) }}


                </div>
                <div class="col">
                <h3>Votre date départ</h3>
                {{ form_row(form.createdAt, {'attr': {'class': 'datepicker'}}) }}
                </div>
            </div>
           
        <hr>
            <div class="row mt-4">
                <h4>
                Montant total de la réservation : 
                <span id="amount"> </span> &euro; pour
                <span id="days"></span> nuit(s) à {{ad.price}}&euro;/nuit
            </h4>
            </div>
            <hr>
            <div class="row">
                <h4>
                Envoyez un message à l'hôte
            </h4>
              {{form_row(form.comment,{'attr':{'rows':5}})}}

            
            </div>
            <button type="submit" class="btn btn-success my-3">Réserver</button>
            
            {{form_end(form)}}
            

    </div>


    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <script>
    // Ici on va créer une fonction qui va permettre de désactiver les dates qui ne sont pas disponibles
        $(document).ready(function() {
            $('#booking_createdAt,#booking_startDate').datepicker({
                format: 'dd/mm/yyyy', // On va formater la date en français
                startDate: new Date(), // On ne peut pas choisir une date antérieure à aujourd'hui
                // On va désactiver les dates qui ne sont pas disponibles pour cette annonce (notAvailableDays) qui sont envoyées par le contrôleur
                dateDisable: [
                    {% for day in ad.notAvailableDays %}
                        "{{day.format('d/m/Y')}}",
                    {% endfor %}
                ],

            });
        });

        $('#booking_startDate').on('change', calculateAmount);
        $('#booking_createdAt').on('change', calculateAmount);

        function calculateAmount() {

            const startDate = new Date($('#booking_startDate').val().replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3'));
            const endDate = new Date($('#booking_createdAt').val().replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3'));

            if (startDate && endDate && startDate < endDate) {
                const DAYS_TIME = 24 * 60 * 60 * 1000;

                const interval = (endDate.getTime() - startDate.getTime()) 

                const days = interval / DAYS_TIME;
                // On arrondi à l'entier supérieur
               // days = Math.ceil(days);

                const amount = days * {{ad.price}};
                // arrondi à 2 chiffres après la virgule
                //amount = amount.toFixed(2);

                $('#days').text(Math.ceil(days));
                $('#amount').text(amount.toFixed(2));
            }
        }
    </script>
{% endblock %}


